<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graficadora Matemática Pro</title>

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/nerdamer.core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Algebra.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Calculus.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Solve.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600;700&family=Roboto+Mono&display=swap');

        body { background: #fdfdfd; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; font-family: 'Open Sans', sans-serif; color: #333; }
        
        .contenedor-principal {
            max-width: 850px; width: 100%; padding: 40px 30px;
            background: #F2F2F2; border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.06);
            text-align: center;
        }

        .header h1 { font-family: 'Playfair Display', serif; font-size: 32px; margin: 0; }
        .header p { font-family: 'Playfair Display', serif; font-size: 18px; color: #666; margin-bottom: 25px; }

        .input-box { display: flex; gap: 12px; align-items: center; background: white; padding: 12px 20px; border-radius: 30px; border: 1px solid #ddd; margin-bottom: 15px; }
        .fn-input { flex: 1; border: none; outline: none; font-family: 'Roboto Mono', monospace; font-size: 16px; }
        .btn-del { background: none; border: none; color: #ff5e5e; font-size: 22px; cursor: pointer; font-weight: bold; }

        /* PÍLDORAS */
        .pills-container {
            background: #E0E0E0; padding: 6px; border-radius: 50px;
            display: flex; gap: 5px; margin: 25px 0; border: 1px solid #D1D1D1;
        }
        .pill {
            background: transparent; border: none; padding: 12px 20px;
            border-radius: 40px; font-size: 13px; font-weight: 700; color: #666;
            cursor: pointer; transition: 0.3s; flex: 1;
        }
        .pill.active { background: white; color: black; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        #jxgbox { 
            width: 100%; height: 500px; border-radius: 30px; 
            background-color: white !important; border: 1px solid #ddd;
            margin-bottom: 25px; overflow: hidden;
        }

        .btn-png { 
            background: white; border: 1px solid #ccc; border-radius: 30px; 
            padding: 12px 25px; font-weight: 700; cursor: pointer; 
            display: inline-flex; align-items: center; gap: 10px; margin-bottom: 20px;
        }

        .grid-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; }
        .table-res { background: white; border-radius: 25px; padding: 20px; border: 1px solid #ddd; max-height: 250px; overflow-y: auto; }
        table { width: 100%; font-size: 12px; border-collapse: collapse; }
        td { padding: 8px; border-bottom: 1px solid #f0f0f0; }
        
        .badge { padding: 3px 8px; border-radius: 6px; color: white; font-size: 10px; font-weight: bold; }
        select { padding: 10px; border-radius: 15px; border: 1px solid #ccc; margin-bottom: 15px; display: none; width: 200px; }
    </style>
</head>
<body>

<div class="contenedor-principal">
    <div class="header">
        <h1>Graficadora 2D</h1>
        <p>√(Raiz) Cuadrada²</p>
    </div>

    <div id="inputs-list"></div>
    <button onclick="addInput()" style="background:none; border:2px dashed #aaa; width:100%; padding:12px; border-radius:25px; cursor:pointer; font-weight:bold; color:#888; margin-bottom:15px;">+ Añadir Función</button>

    <div class="pills-container">
        <button class="pill active" onclick="setMode('normal', this)">Vista Normal</button>
        <button class="pill" onclick="setMode('especiales', this)">Puntos especiales</button>
    </div>

    <select id="target-fn" onchange="render()"></select>

    <button class="btn-png" onclick="descargarPNG()">
        <img src="https://cdn-icons-png.flaticon.com/512/724/724933.png" width="16"> Descargar en PNG
    </button>

    <div id="jxgbox" class="jxgbox"></div>

    <div class="grid-info">
        <div class="table-res">
            <strong>Coordenadas Detectadas</strong>
            <table><tbody id="puntos-body"></tbody></table>
        </div>
        <div style="font-size: 12px; color: #555; background: white; padding: 20px; border-radius: 25px; border: 1px solid #ddd;">
            <span style="color:#f1c40f">●</span> Cortes Ejes (Amarillo)<br>
            <span style="color:#3498db">●</span> Máximos (Azul)<br>
            <span style="color:#e74c3c">●</span> Mínimos (Rojo)<br><br>
            <em>Haz click en los puntos para ver sus coordenadas exactas en el plano.</em>
        </div>
    </div>
</div>

<script>
let board;
let modo = 'normal';

function initBoard() {
    board = JXG.JSXGraph.initBoard('jxgbox', {
        boundingbox: [-10, 10, 10, -10],
        axis: true,
        showCopyright: false,
        keepaspectratio: false,
        pan: { enabled: true },
        zoom: { wheel: true, factor: 1.2 }
    });
}

function setMode(m, btn) {
    modo = m;
    document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('target-fn').style.display = (m === 'especiales') ? 'inline-block' : 'none';
    render();
}

function addInput(v = '') {
    const div = document.createElement('div');
    div.className = 'input-box';
    div.innerHTML = `
        <input type="color" value="#333333" onchange="render()">
        <input class="fn-input" placeholder="Ej: x^2 - 4" value="${v}" oninput="render(); updateSel();">
        <button class="btn-del" onclick="this.parentElement.remove(); render(); updateSel();">×</button>
    `;
    document.getElementById('inputs-list').appendChild(div);
    updateSel();
    render();
}

function updateSel() {
    const sel = document.getElementById('target-fn');
    sel.innerHTML = "";
    document.querySelectorAll('.fn-input').forEach((input, i) => {
        if(input.value.trim()){
            let opt = document.createElement('option');
            opt.value = i; opt.text = `Analizar f${i+1}`;
            sel.add(opt);
        }
    });
}

function render() {
    if (!board) initBoard();
    JXG.JSXGraph.freeBoard(board);
    initBoard();

    const rows = document.querySelectorAll('.input-box');
    const tableBody = document.getElementById('puntos-body');
    tableBody.innerHTML = "";
    const targetIdx = document.getElementById('target-fn').value || 0;

    rows.forEach((row, i) => {
        let rawFn = row.querySelector('.fn-input').value;
        let col = row.querySelector('input[type="color"]').value;
        if (!rawFn) return;

        try {
            // Dibujar Función
            let f = board.create('functiongraph', [x => {
                try { return parseFloat(nerdamer(rawFn).evaluate({x: x}).toString()); } catch(e) { return NaN; }
            }], { strokeColor: col, strokeWidth: 3 });

            // Puntos Especiales
            if (modo === 'especiales' && i == targetIdx) {
                // 1. Cortes con X (Raíces)
                let roots = nerdamer.solve(rawFn, 'x').symbol.elements;
                roots.map(r => parseFloat(nerdamer(r).evaluate())).filter(v => !isNaN(v)).slice(0, 6).forEach(rx => {
                    crearPunto(rx, 0, '#f1c40f', 'Corte X', tableBody);
                });

                // 2. Corte con Y
                let y0 = parseFloat(nerdamer(rawFn).evaluate({x: 0}));
                if(!isNaN(y0)) crearPunto(0, y0, '#f1c40f', 'Corte Y', tableBody);

                // 3. Máximos y Mínimos
                let d1 = nerdamer.diff(rawFn, 'x').toString();
                let d2 = nerdamer.diff(d1, 'x').toString();
                let crits = nerdamer.solve(d1, 'x').symbol.elements;

                crits.map(c => parseFloat(nerdamer(c).evaluate())).filter(v => !isNaN(v)).slice(0, 6).forEach(cx => {
                    let cy = parseFloat(nerdamer(rawFn).evaluate({x: cx}));
                    let curv = parseFloat(nerdamer(d2).evaluate({x: cx}));
                    if (curv < 0) crearPunto(cx, cy, '#3498db', 'Máximo', tableBody);
                    else if (curv > 0) crearPunto(cx, cy, '#e74c3c', 'Mínimo', tableBody);
                });
            }
        } catch(e) {}
    });
}

function crearPunto(x, y, color, tipo, table) {
    let p = board.create('point', [x, y], {
        name: tipo.charAt(0),
        strokeColor: color,
        fillColor: color,
        size: 5,
        label: { visible: false } // Se muestra al hacer click
    });

    // Al hacer click, muestra la coordenada encima
    p.on('down', function() {
        p.setAttribute({ label: { visible: true, offset: [0, 15] } });
        p.label.setText(`(${x.toFixed(2)}, ${y.toFixed(2)})`);
    });

    table.innerHTML += `<tr><td><span class="badge" style="background:${color}">${tipo}</span></td><td>(${x.toFixed(2)}, ${y.toFixed(2)})</td></tr>`;
}

function descargarPNG() {
    // JSXGraph no exporta a PNG directo fácilmente, usamos un truco de captura
    const svg = document.querySelector('#jxgbox svg');
    const xml = new XMLSerializer().serializeToString(svg);
    const svg64 = btoa(unescape(encodeURIComponent(xml)));
    const img = new Image();
    img.src = 'data:image/svg+xml;base64,' + svg64;
    img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = 1000; canvas.height = 800;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, 1000, 800);
        const link = document.createElement('a');
        link.download = 'grafica_matematica.png';
        link.href = canvas.toDataURL();
        link.click();
    };
}

window.onload = () => { addInput('x^2 - 4'); };
</script>
</body>
</html>
