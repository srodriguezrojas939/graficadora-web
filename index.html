<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graficadora Ultra Pro - Raíz Cuadrada</title>

    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/nerdamer.core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Algebra.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Calculus.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Solve.js"></script>
    <script src="https://unpkg.com/d3@3/d3.min.js"></script>
    <script src="https://unpkg.com/function-plot/dist/function-plot.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600;700&family=Roboto+Mono&display=swap');

        body { background: #f8f9fa; font-family: 'Open Sans', sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { max-width: 800px; width: 100%; background: #ffffff; padding: 30px; border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.05); }
        
        h1 { font-family: 'Playfair Display', serif; text-align: center; margin: 0; font-size: 28px; }
        p.subtitle { text-align: center; color: #666; font-size: 14px; margin-bottom: 25px; }

        /* Estilo de Inputs y Colores */
        .input-row { display: flex; gap: 10px; align-items: center; background: #f1f3f5; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; }
        .fn-input { flex: 1; border: none; background: transparent; font-family: 'Roboto Mono', monospace; font-size: 16px; outline: none; }
        input[type="color"] { border: none; width: 30px; height: 30px; cursor: pointer; background: none; }

        /* Sliders Dinámicos */
        .sliders-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 25px; }
        .slider-item { display: flex; flex-direction: column; align-items: center; }
        .slider-item label { font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        input[type="range"] { width: 100%; accent-color: #000; }

        /* Píldoras de Navegación */
        .pills { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; margin-bottom: 20px; scrollbar-width: none; }
        .pill { background: #eee; border: none; padding: 10px 18px; border-radius: 25px; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .pill.active { background: #000; color: #fff; }

        /* Gráfica */
        #grafica-wrapper { background: white; border: 1px solid #eee; border-radius: 30px; overflow: hidden; position: relative; }
        #grafica { width: 100%; }

        /* Tabla y Resultados */
        .data-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .table-container { background: #f8f9fa; border-radius: 20px; padding: 15px; max-height: 200px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { text-align: left; border-bottom: 2px solid #ddd; padding: 5px; }
        td { padding: 5px; border-bottom: 1px solid #eee; font-family: 'Roboto Mono', monospace; }

        /* Panel de Símbolos */
        .symbol-pad { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 25px; border-top: 2px dashed #eee; pt: 20px; }
        .sym-btn { background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 12px; cursor: pointer; font-family: 'Roboto Mono', monospace; font-weight: bold; transition: 0.2s; }
        .sym-btn:hover { background: #000; color: #fff; border-color: #000; }

        @media (max-width: 600px) { .data-section { grid-template-columns: 1fr; } .sliders-box { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1>Graficadora 2D Ultra</h1>
    <p class="subtitle">Laboratorio Matemático Inteligente</p>

    <div id="inputs-list"></div>
    <button onclick="addInput()" style="width:100%; background:none; border:2px dashed #ccc; padding:10px; border-radius:20px; cursor:pointer; font-weight:bold; margin-bottom:15px;">+ Agregar f(x) o Desigualdad</button>

    <div class="sliders-box">
        <div class="slider-item">
            <label>Variable a: <span id="val-a">1</span></label>
            <input type="range" id="slider-a" min="-10" max="10" step="0.1" value="1" oninput="updateSliders()">
        </div>
        <div class="slider-item">
            <label>Variable b: <span id="val-b">0</span></label>
            <input type="range" id="slider-b" min="-10" max="10" step="0.1" value="0" oninput="updateSliders()">
        </div>
        <div class="slider-item">
            <label>Variable c: <span id="val-c">0</span></label>
            <input type="range" id="slider-c" min="-10" max="10" step="0.1" value="0" oninput="updateSliders()">
        </div>
    </div>

    <div class="pills">
        <button class="pill active" onclick="setMode('normal', this)">Vista Normal</button>
        <button class="pill" onclick="setMode('puntos', this)">Puntos Críticos</button>
        <button class="pill" onclick="setMode('area', this)">Área bajo curva</button>
        <button class="pill" onclick="setMode('asintotas', this)">Detectar Asíntotas</button>
    </div>

    <div id="grafica-wrapper">
        <div id="grafica"></div>
    </div>

    <div class="data-section">
        <div class="table-container">
            <table>
                <thead><tr><th>x</th><th>f(x)</th></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <div id="info-panel" style="font-size: 13px; line-height: 1.6;">
            <strong>Análisis en tiempo real:</strong><br>
            Mueve los sliders o usa el mouse sobre la gráfica para explorar.
        </div>
    </div>

    <div class="symbol-pad">
        <button class="sym-btn" onclick="insertSym('^2')">x²</button>
        <button class="sym-btn" onclick="insertSym('sqrt(')">√</button>
        <button class="sym-btn" onclick="insertSym('sin(')">sin</button>
        <button class="sym-btn" onclick="insertSym('cos(')">cos</button>
        <button class="sym-btn" onclick="insertSym('pi')">π</button>
        <button class="sym-btn" onclick="insertSym('abs(')">|x|</button>
        <button class="sym-btn" onclick="insertSym(' > ')">></button>
        <button class="sym-btn" onclick="insertSym(' < ')"><</button>
        <button class="sym-btn" onclick="insertSym('log(')">log</button>
        <button class="sym-btn" onclick="insertSym('exp(')">exp</button>
        <button class="sym-btn" onclick="insertSym('(')">(</button>
        <button class="sym-btn" onclick="insertSym(')')">)</button>
    </div>
</div>

<script>
let mode = 'normal';
let lastActiveInput = null;

function setMode(m, btn) {
    mode = m;
    document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    draw();
}

function addInput(val = '', col = '#000000') {
    const id = Date.now();
    const div = document.createElement('div');
    div.className = 'input-row';
    div.innerHTML = `
        <input type="color" value="${col}" onchange="draw()">
        <input class="fn-input" placeholder="Ej: a*x^2 + b" value="${val}" oninput="draw()" onfocus="lastActiveInput=this">
        <button onclick="this.parentElement.remove(); draw()" style="border:none; background:none; cursor:pointer; font-weight:bold;">×</button>
    `;
    document.getElementById('inputs-list').appendChild(div);
    if(!lastActiveInput) lastActiveInput = div.querySelector('.fn-input');
}

function insertSym(sym) {
    if(lastActiveInput) {
        const start = lastActiveInput.selectionStart;
        const end = lastActiveInput.selectionEnd;
        const text = lastActiveInput.value;
        lastActiveInput.value = text.slice(0, start) + sym + text.slice(end);
        lastActiveInput.focus();
        draw();
    }
}

function updateSliders() {
    document.getElementById('val-a').innerText = document.getElementById('slider-a').value;
    document.getElementById('val-b').innerText = document.getElementById('slider-b').value;
    document.getElementById('val-c').innerText = document.getElementById('slider-c').value;
    draw();
}

function draw() {
    const a = document.getElementById('slider-a').value;
    const b = document.getElementById('slider-b').value;
    const c = document.getElementById('slider-c').value;
    const inputs = document.querySelectorAll('.input-row');
    const data = [];
    
    let firstFn = "";

    inputs.forEach((row, i) => {
        let rawFn = row.querySelector('.fn-input').value.trim();
        const color = row.querySelector('input[type="color"]').value;
        
        if(!rawFn) return;

        // Reemplazar variables a, b, c
        let processedFn = rawFn.replace(/a/g, `(${a})`).replace(/b/g, `(${b})`).replace(/c/g, `(${c})`);
        
        if(i === 0) firstFn = processedFn;

        // Detectar Desigualdades
        let isInequality = processedFn.includes('>') || processedFn.includes('<');
        
        if(isInequality) {
            const parts = processedFn.split(/[><]/);
            const side = processedFn.includes('>') ? 'y' : 'y'; // Simplificado para demo
            data.push({
                fn: parts[1],
                fill: color,
                skipTip: true,
                fnType: 'implicit' // Aproximación para desigualdades simples
            });
        } else {
            data.push({
                fn: processedFn,
                color: color,
                range: [-10, 10],
                closed: mode === 'area' && i === 0,
                graphType: 'polyline' // Ayuda con asíntotas
            });
        }
    });

    // Puntos Críticos
    if(mode === 'puntos' && firstFn) {
        try {
            let der = nerdamer.diff(firstFn, 'x').toString();
            let sol = nerdamer.solve(der, 'x').symbol.elements;
            sol.forEach(s => {
                let xVal = parseFloat(nerdamer(s).evaluate());
                let yVal = parseFloat(nerdamer(firstFn).evaluate({x: xVal}));
                data.push({ points: [[xVal, yVal]], fnType: 'points', graphType: 'scatter', color: 'red' });
            });
        } catch(e){}
    }

    const width = document.getElementById('grafica-wrapper').offsetWidth;
    functionPlot({
        target: '#grafica',
        width: width,
        height: 400,
        grid: true,
        tip: { xLine: true, yLine: true }, // Sugerencia #3 Rastreo
        data: data
    });

    updateTable(firstFn);
}

function updateTable(fn) {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = "";
    if(!fn) return;
    for(let x = -5; x <= 5; x++) {
        try {
            let y = parseFloat(nerdamer(fn).evaluate({x: x})).toFixed(2);
            tbody.innerHTML += `<tr><td>${x}</td><td>${y}</td></tr>`;
        } catch(e){}
    }
}

window.onload = () => {
    addInput('a*x^2 + b', '#5D8AA8');
    updateSliders();
};
window.onresize = draw;

</script>
</body>
</html>
