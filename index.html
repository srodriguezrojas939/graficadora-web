<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora y Graficadora Pro</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/algebrite@1.4.0/dist/algebrite.bundle-for-browser.min.js"></script>
    <script src="https://unpkg.com/function-plot/dist/function-plot.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Open+Sans:wght@400;600;700&display=swap');

        body { background: white; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; font-family: 'Open Sans', sans-serif; }
        .container { width: 100%; max-width: 600px; background: #F2F2F2; padding: 30px 20px; border-radius: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        .header-section { text-align: center; margin-bottom: 20px; }
        .header-section h1 { font-family: 'Playfair Display', serif; font-size: 32px; margin: 0; font-weight: 600; text-transform: lowercase; }

        #preview-container { background: white; margin-bottom: 20px; padding: 20px; border-radius: 20px; min-height: 70px; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; overflow-x: auto; }

        /* DISTANCIA EXACTA DE 34PX */
        #graph-section { margin-top: 34px; background: white; border-radius: 20px; padding: 15px; border: 1px solid #eee; position: relative; }
        #root { width: 100%; height: 350px; }

        label { display: block; font-size: 14px; color: #444; margin: 0 0 6px 12px; font-weight: 600; }
        input { width: 100%; padding: 14px 18px; margin-bottom: 15px; border-radius: 25px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; outline: none; background: white; }

        .btn-principal { width: 100%; background: black; color: white; border: none; padding: 18px; border-radius: 30px; font-size: 16px; cursor: pointer; font-weight: 700; margin-bottom: 12px; }
        
        /* BOTÓN DE DESCARGA SEGÚN IMAGEN */
        .btn-download {
            width: 100%; background: white; color: #000; border: 1px solid #ccc; padding: 15px; border-radius: 30px; 
            font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; margin-top: 15px;
        }
        .btn-download img { width: 20px; height: 20px; }

        /* TABLA DE VALORES ESTÉTICA */
        .table-container { margin-top: 25px; background: white; border-radius: 20px; padding: 20px; border: 1px solid #eee; }
        .table-container h3 { font-family: 'Playfair Display', serif; font-size: 18px; margin-top: 0; text-align: center; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { border-bottom: 2px solid #F2F2F2; padding: 10px; color: #666; }
        td { padding: 10px; text-align: center; border-bottom: 1px solid #F2F2F2; color: #333; }
        tr:last-child td { border-bottom: none; }

        .special-points-list { margin-top: 15px; font-size: 13px; color: #555; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 10px; }
        .point-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>graficadora pro</h1>
    </div>

    <div id="preview-container">
        <div id="latex-preview">$$ f(x) = \dots $$</div>
    </div>

    <label>función a graficar</label>
    <input id="funcion" placeholder="Ej: x^2 - 4" type="text" oninput="actualizarVistaPrevia()">

    <button onclick="ejecutarTodo()" class="btn-principal">Generar Gráfica y Tabla</button>

    <div id="graph-section">
        <div id="root"></div>
        <div class="special-points-list" id="points-info"></div>
    </div>

    <div class="table-container" id="table-box" style="display:none;">
        <h3>tabla de valores</h3>
        <table id="vals-table">
            <thead>
                <tr><th>x</th><th>f(x)</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button onclick="descargarImagen()" class="btn-download">
        <img src="https://cdn-icons-png.flaticon.com/512/724/724933.png" alt="download">
        Descargar en PNG
    </button>
</div>

<script>
let instance = null;

function actualizarVistaPrevia() {
    const input = document.getElementById('funcion').value.trim();
    const preview = document.getElementById('latex-preview');
    if (!input) {
        preview.innerHTML = `$$ f(x) = \\dots $$`;
    } else {
        try {
            const tex = Algebrite.run(`printlatex(${input.replace(/ln/g, 'log')})`);
            preview.innerHTML = `$$ f(x) = ${tex} $$`;
        } catch (e) { preview.innerHTML = `$$ \dots $$`; }
    }
    MathJax.typesetPromise([preview]);
}

function ejecutarTodo() {
    const expr = document.getElementById('funcion').value.trim();
    if (!expr) return;

    graficar(expr);
    generarTabla(expr);
}

function graficar(fStr) {
    const compiled = math.compile(fStr);
    const annotations = [];
    const infoDiv = document.getElementById('points-info');
    infoDiv.innerHTML = '';

    // Buscar puntos especiales (Raíces e Intersección Y)
    try {
        // Intersección Y
        const yInt = compiled.evaluate({x: 0});
        if (!isNaN(yInt)) {
            annotations.push({ y: yInt, text: 'Int Y' });
            agregarInfoPunto('Int Y', 0, yInt, '#FF5722');
        }

        // Raíces aproximadas (de -10 a 10)
        for(let i = -10; i <= 10; i += 0.5) {
            try {
                const root = math.findRoot(compiled, i);
                if (Math.abs(compiled.evaluate({x: root})) < 0.01) {
                    annotations.push({ x: root, text: 'Raíz' });
                    agregarInfoPunto('Raíz', root, 0, '#4CAF50');
                }
            } catch(e){}
        }
    } catch(e) { console.log("Error buscando puntos"); }

    instance = functionPlot({
        target: '#root',
        width: 540,
        height: 350,
        grid: true,
        data: [{
            fn: fStr,
            sampler: 'builtIn',
            graphType: 'polyline',
            color: 'black'
        }],
        annotations: annotations
    });
}

function agregarInfoPunto(tipo, x, y, color) {
    const div = document.getElementById('points-info');
    div.innerHTML += `
        <div class="point-item">
            <span class="dot" style="background:${color}"></span>
            <b>${tipo}:</b> (${x.toFixed(2)}, ${y.toFixed(2)})
        </div>`;
}

function generarTabla(fStr) {
    const tbody = document.querySelector('#vals-table tbody');
    const tableBox = document.getElementById('table-box');
    tbody.innerHTML = '';
    const compiled = math.compile(fStr);

    const puntos = [-3, -2, -1, 0, 1, 2, 3];
    puntos.forEach(x => {
        try {
            const y = compiled.evaluate({x: x});
            const row = `<tr><td>${x}</td><td>${y.toFixed(2)}</td></tr>`;
            tbody.innerHTML += row;
        } catch(e) {}
    });

    tableBox.style.display = 'block';
}

function descargarImagen() {
    const container = document.querySelector('.container');
    html2canvas(container, { backgroundColor: '#ffffff', borderRadius: 35 }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'mi_grafica_pro.png';
        link.href = canvas.toDataURL();
        link.click();
    });
}

// Inicialización
actualizarVistaPrevia();
</script>

</body>
</html>
