<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Graficadora Pro - Raiz Cuadrada</title>

    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/nerdamer.core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Algebra.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Calculus.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Solve.js"></script>
    <script src="https://unpkg.com/d3@3/d3.min.js"></script>
    <script src="https://unpkg.com/function-plot/dist/function-plot.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap');

        /* Reset y layout base */
        *, *::before, *::after { box-sizing: border-box; }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #ffffff;
            font-family: 'Open Sans', sans-serif;
            -webkit-text-size-adjust: 100%;
            overflow-x: hidden; /* evita scroll horizontal en móviles */
        }

        /* Contenedor centrado pero responsivo */
        .page-wrap {
            display: flex;
            justify-content: center;
            align-items: flex-start; /* top en pantallas pequeñas evita recortes por centrado vertical */
            min-height: 100vh;
            padding: 10px; /* pequeño buffer para que no pegue al borde del iframe */
        }

        .calculadora-moderna {
            width: 100%;
            max-width: 920px;
            background: #F2F2F2;
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .header-section { text-align: center; margin-bottom: 4px; }
        .header-section h1 { font-size: 20px; margin: 0; font-family: 'Playfair Display', serif; }
        .header-section p { font-size: 13px; font-weight: 600; color: #333; margin: 2px 0 8px; }

        label { display: block; font-size: 12px; margin-bottom: 6px; margin-left: 4px; font-weight: 600; }

        .input-list { display: flex; flex-direction: column; gap: 8px; }

        .input-group {
            display: flex; gap: 8px; position: relative;
            align-items: center;
        }

        input, select {
            font-family: 'Open Sans', sans-serif;
            font-size: 13px;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 20px;
            background: white;
            transition: 0.18s;
        }

        .input-group .fn-input { flex: 1; min-width: 0; }

        .input-group .color-select {
            width: 36px; height: 36px; border-radius: 50%;
            padding: 0; border: 2px solid #e0e0e0; cursor: pointer;
            color: transparent;
        }

        .btn-remove {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            background: black; color: white; border: none;
            border-radius: 50%; width: 28px; height: 28px;
            font-size: 16px; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        #modo { flex: 1; min-width: 160px; padding: 10px 12px; }

        .botones-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .boton-estilo {
            display: inline-flex; align-items: center; gap: 8px; justify-content: center;
            background: white; border: 1px solid #ccc; border-radius: 20px;
            padding: 8px 12px; cursor: pointer; font-weight: 600; font-size: 13px;
        }
        .boton-principal { background: black; color: white; border: none; }

        /* Contenedor gráfico adaptativo */
        #contenedor-grafica {
            width: 100%;
            background: white;
            border-radius: 12px;
            padding: 8px;
            border: 1px solid #ddd;
            overflow: hidden;
        }
        #grafica { width: 100%; height: 100%; }

        #info-box { text-align: center; font-size: 12px; color: #666; font-weight: 600; margin-top: 4px; }

        /* Mobile tweaks */
        @media (max-width: 480px) {
            .calculadora-moderna { padding: 12px; border-radius: 12px; }
            .header-section h1 { font-size: 18px; }
            .header-section p { font-size: 12px; }
            .botones-container { justify-content: space-between; }
            .btn-remove { right: -4px; width: 26px; height: 26px; font-size: 15px; }
            label { font-size: 11px; }
            input, select { font-size: 13px; padding: 9px 10px; }
        }
    </style>
</head>
<body>

<div class="page-wrap">
    <div class="calculadora-moderna" id="app">
        <div class="header-section">
            <h1>Graficadora Inteligente</h1>
            <p>√(Raiz) Cuadrada²</p>
        </div>

        <div id="lista-funciones" class="input-list">
            <label>Funciones f(x)</label>
        </div>

        <div class="controls-row">
            <button onclick="agregarInput()" class="boton-estilo" style="flex: 0 0 auto;">+ Añadir otra función</button>

            <label style="margin:0 0 0 6px; align-self:center;">Modo</label>
            <select id="modo">
                <option value="normal">Vista Normal</option>
                <option value="puntos">Máximos, Mínimos y Raíces</option>
                <option value="area_curva">Área Bajo la Curva (f1 al Eje X)</option>
            </select>

            <div style="flex:1"></div>

            <div class="botones-container" style="margin-left:auto;">
                <button onclick="procesar()" class="boton-estilo boton-principal">Actualizar</button>
                <button onclick="exportarImagen()" class="boton-estilo">
                    <img src="https://cdn-icons-png.flaticon.com/512/724/724933.png" width="14" style="margin-right:4px">
                    Descargar PNG
                </button>
            </div>
        </div>

        <div id="contenedor-grafica" aria-hidden="false">
            <div id="grafica"></div>
        </div>
        <div id="info-box"></div>
    </div>
</div>

<canvas id="canvas-export" style="display:none;"></canvas>

<script>
/* Paleta y helpers */
const paletaElegante = {
    '#333333': 'Negro Carbón',
    '#5D8AA8': 'Azul Acero',
    '#6B8E23': 'Verde Oliva',
    '#A52A2A': 'Rojo Vino',
    '#7F5A8B': 'Púrpura Tenue',
    '#B87333': 'Bronce Antiguo'
};

function generarOpcionesColor(colorSeleccionado) {
    let html = '';
    for (const [hex, nombre] of Object.entries(paletaElegante)) {
        const selected = hex === colorSeleccionado ? 'selected' : '';
        html += `<option value="${hex}" ${selected} style="background-color: ${hex}; color: transparent;">${nombre}</option>`;
    }
    return html;
}

/* Agrega un input para funciones */
function agregarInput(valorInicial = '', colorInicial = '#333333') {
    const container = document.getElementById('lista-funciones');
    const div = document.createElement('div');
    div.className = 'input-group';
    div.innerHTML = `
        <input class="fn-input" placeholder="Ej: x^2" value="${valorInicial}">
        <select class="color-select" style="background-color: ${colorInicial};" onchange="this.style.backgroundColor = this.value">
            ${generarOpcionesColor(colorInicial)}
        </select>
        <button class="btn-remove" title="Eliminar" onclick="if(document.querySelectorAll('.input-group').length > 1) { this.parentElement.remove(); procesar(); }">×</button>
    `;
    container.appendChild(div);
}

/* Calcula tamaño del plot según contenedor y viewport para evitar cortes */
function calcularTamanioPlot() {
    const cont = document.getElementById('contenedor-grafica');
    const maxHeightByViewport = Math.max(220, Math.floor(window.innerHeight * 0.45)); // no más grande que 45% de la altura de pantalla
    const width = Math.max(300, cont.clientWidth - 4); // ancho mínimo
    // relación de aspecto aproximada; adaptamos para móvil
    const height = Math.min(580, Math.max(220, Math.round(width * 0.56), maxHeightByViewport));
    return { width, height };
}

/* Debounce rápido para resize */
function debounce(fn, wait = 120) {
    let t;
    return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
    };
}

/* Procesar y dibujar gráfico (ahora responsivo) */
function procesar() {
    const gruposInputs = document.querySelectorAll('.input-group');
    const modo = document.getElementById('modo').value;
    const info = document.getElementById('info-box');
    document.getElementById('grafica').innerHTML = "";

    let data = [];
    let funcionesValidas = [];

    try {
        gruposInputs.forEach((grupo) => {
            const fnValue = grupo.querySelector('.fn-input').value.trim();
            const colorValue = grupo.querySelector('.color-select').value;
            if (fnValue !== "") {
                funcionesValidas.push({ fn: fnValue, color: colorValue });
                data.push({ fn: fnValue, color: colorValue });
            }
        });

        if (modo === 'puntos') {
            funcionesValidas.forEach((item) => {
                try {
                    let der = nerdamer.diff(item.fn, 'x').toString();
                    let criticos = nerdamer.solve(der, 'x').symbol.elements;
                    criticos.forEach(c => {
                        // intento razonable de extraer valor numérico
                        const maybe = parseFloat(c.toString());
                        if (!isNaN(maybe)) {
                            const x = maybe;
                            const y = parseFloat(nerdamer(item.fn).evaluate({ x }).toString());
                            if (!isNaN(x) && !isNaN(y)) {
                                data.push({ points: [[x, y]], fnType: 'points', graphType: 'scatter', color: item.color, attr: { r: 6, stroke: 'black', 'stroke-width': 2 } });
                            }
                        }
                    });
                } catch (e) {}
            });
            info.textContent = "Marcando puntos críticos y raíces";
        } else {
            info.textContent = "";
        }

        if (modo === 'area_curva' && funcionesValidas.length >= 1) {
            data[0].closed = true;
            info.textContent = "Área de la primera función respecto al eje X";
        }

        const size = calcularTamanioPlot();

        functionPlot({
            target: "#grafica",
            width: size.width,
            height: size.height,
            grid: true,
            data: data
        });

    } catch (e) {
        info.innerHTML = "<span style='color:red'>Error matemático</span>";
    }
}

/* Exporta PNG con marca de agua; usa tamaño del SVG actual para buena resolución */
function exportarImagen() {
    const svgElement = document.querySelector('#grafica svg');
    if (!svgElement) return alert('No hay gráfico para exportar');

    const canvas = document.getElementById('canvas-export');
    const ctx = canvas.getContext('2d');
    const svgData = new XMLSerializer().serializeToString(svgElement);
    const img = new Image();
    const svgSize = svgElement.getBoundingClientRect();

    const scale = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.round(svgSize.width * scale);
    canvas.height = Math.round(svgSize.height * scale);

    const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(svgBlob);

    img.onload = function () {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        ctx.font = `bold ${Math.round(24 * scale)}px 'Playfair Display'`;
        ctx.fillStyle = "rgba(0,0,0,0.28)";
        ctx.textAlign = "right";
        ctx.fillText("√(Raiz) Cuadrada²", canvas.width - 12 * scale, canvas.height - 12 * scale);
        const link = document.createElement('a');
        link.download = 'grafica-raiz-cuadrada.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        URL.revokeObjectURL(url);
    };
    img.src = url;
}

/* Inicialización y redibujo en resize/orientationchange */
window.addEventListener('load', () => {
    // Añadimos dos funciones por defecto
    agregarInput('x^2', '#333333');
    agregarInput('x + 2', '#5D8AA8');
    procesar();
});

// Redibuja cuando cambie tamaño de contenedor/ventana
window.addEventListener('resize', debounce(() => {
    procesar();
}, 120));
window.addEventListener('orientationchange', debounce(() => {
    // en algunos navegadores orientationchange no dispara resize de inmediato
    setTimeout(procesar, 180);
}, 180));
</script>

</body>
</html>
